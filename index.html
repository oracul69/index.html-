<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>vortoX — Two-Card Multiplayer Prototype</title>
<style>
  :root{
    --bg:#0b0b0b; --text:#f5f5f5; --muted:#a0a6ad;
    --panel:#121212; --edge:#222; --card:#0e0f10;
    --accent:#25c05a; --accent-dark:#1ea14a;
    --red:#e53935; --blue:#1e88e5; --trap:#ff3b30; --gold:#f7c948;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:18px 14px}

  /* Brand */
  .brand{display:flex;justify-content:center;align-items:center;margin:6px 0 10px}
  .brand .name{font-weight:900;font-size:26px;letter-spacing:.2px}
  .brand .name .x{color:#5cf27e}
  .badge{margin-left:8px;background:#1c1c1c;border:1px solid #2b2b2b;border-radius:999px;padding:2px 8px;font-size:11px;color:#a7d8b4;font-weight:800}

  /* Panels */
  .panel{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:12px;margin-bottom:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .stat{background:#0f0f0f;border:1px solid #242424;border-radius:12px;padding:8px 10px;min-width:130px}
  .stat .k{display:block;font-size:12px;color:#c7c7c7}
  .stat .v{display:block;font-weight:900;font-size:18px}

  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:800}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:#1b1b1b;border:1px solid #333;color:#e7e7e7}
  .btn-accent{background:var(--accent);color:#07190e}

  /* HUD */
  .hud{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .pill{background:#0f0f0f;border:1px solid #242424;border-radius:999px;padding:6px 10px;font-weight:800}

  .timerbar{height:12px;background:#161616;border:1px solid #2b2b2b;border-radius:999px;overflow:hidden}
  .timerfill{height:100%;width:100%;background:linear-gradient(90deg,#4caf50,#8bc34a);transform-origin:left;transform:scaleX(1)}
  .timeText{margin-top:6px;text-align:center;font-size:13px;color:#d9d9d9}

  /* Arena */
  .arenaWrap.spectate{opacity:.5}
  .arena{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:12px 0}
  .card{
    position:relative;aspect-ratio:3/5;border-radius:16px;user-select:none;cursor:pointer;
    background:var(--card);
    transform:scale(.60); transition:transform .28s ease,background .2s ease, box-shadow .2s ease;
    perspective:1000px;
  }
  .card.wiggle{animation:wiggle 1.3s ease-in-out infinite}
  @keyframes wiggle {0%{transform:scale(.58)}50%{transform:scale(.62)}100%{transform:scale(.58)}}
  .card.picked{animation:none; transform:scale(1)}
  .card.shrunk{animation:none !important; transform:scale(.60) !important}

  .inner{position:absolute;inset:0;border-radius:16px; transform-style:preserve-3d; transition:transform .55s ease}
  .flip .inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:16px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden}
  .front{
    background:
      radial-gradient(120% 120% at 100% 0%, rgba(255,255,255,.05), transparent 40%),
      linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0));
    color:#eaeaea; font-weight:800; letter-spacing:.06em;
  }
  .back{
    transform:rotateY(180deg);
    font-size:44px; font-weight:900; color:#fff;
    display:flex;align-items:center;justify-content:center;
  }
  /* edges that flip with faces */
  .edgeF,.edgeB{
    position:absolute;inset:0;border-radius:16px;border:2px dashed #2a2a2a; pointer-events:none;
  }
  .edgeB{transform:rotateY(180deg)}
  .edge-red {border-color:#e53935}
  .edge-blue{border-color:#1e88e5}
  .edge-gold{border-color:#f7c948}

  .label{position:absolute;bottom:8px;left:0;right:0;text-align:center;color:#dcdcdc;font-size:13px}

  .success .back{background:linear-gradient(180deg, rgba(37,192,90,.36), rgba(37,192,90,.16));}
  .trap .back   {background:linear-gradient(180deg, rgba(255,59,48,.36), rgba(255,59,48,.16));}
  .bonus .front {box-shadow:0 0 0 1px rgba(255,214,80,.3) inset}
  .bonus .back  {background:linear-gradient(180deg, rgba(255,220,120,.28), rgba(255,204,72,.14));}

  /* Bet bar (reference layout) */
  .betBox{background:#0f0f0f;border:1px solid #242424;border-radius:16px;padding:10px;margin-top:10px}
  .seg{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .seg .tabs{display:flex;background:#1a1a1a;border:1px solid #333;border-radius:999px;overflow:hidden}
  .seg .tabs button{background:transparent;color:#cfcfcf;padding:8px 16px;border:0;font-weight:800}
  .seg .tabs .on{background:#2a2a2a;color:#fff}
  .seg .mini{width:34px;height:34px;border-radius:10px;background:#1a1a1a;border:1px solid #333}

  .betGrid{display:grid;grid-template-columns:260px 1fr;gap:12px}
  .qty{display:grid;grid-template-columns:46px 1fr 46px;gap:8px;align-items:center}
  .roundBtn{height:46px;border-radius:24px;background:#1a1a1a;border:1px solid #333;color:#eee;font-size:20px;font-weight:900}
  .amount{height:46px;display:flex;align-items:center;justify-content:center;background:#0f0f0f;border:1px solid #2b2b2b;border-radius:14px;font-weight:900;font-size:20px}
  .chips{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  .chip{height:42px;background:#1b1b1b;border:1px solid #333;border-radius:12px;color:#eee;font-weight:800}

  .betMain{display:flex;align-items:center}
  .betBtn{width:100%;height:116px;border-radius:16px;background:var(--accent);color:#07190e;border:0;font-weight:900;font-size:28px;line-height:1.1}
  .betBtn span{display:block;font-size:20px;margin-top:6px;opacity:.95}
  .disabled,.betBox.disabled .betBtn{opacity:.45;pointer-events:none}

  .betNote{margin-top:6px;color:var(--muted);font-size:12px;text-align:center}

  /* Cash-out box */
  .cashBox{background:#0f0f0f;border:1px solid #242424;border-radius:16px;padding:10px;margin-top:10px}
  .cashMain{display:grid;grid-template-columns:1fr;gap:10px}
  .bigBtn{width:100%;padding:18px;border-radius:16px;font-weight:900}
  .bigPrimary{background:var(--accent);color:#07190e;font-size:24px}
  .bigPrimary .small{display:block;font-size:16px;opacity:.95}
  .bigHalf{background:var(--accent-dark);color:#07190e;font-size:18px}
  .cashDisabled{opacity:.45;pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <div class="name">vorto<span class="x">X</span></div>
    <span class="badge">v28</span>
  </div>

  <!-- Lobby -->
  <div class="panel" id="lobbyPanel">
    <div class="row">
      <div class="stat"><span class="k">Wallet</span><span class="v" id="walletTop">—</span></div>
      <button class="btn btn-ghost" id="enterBtn">Enter Arena</button>
    </div>
    <p class="muted" style="margin:6px 0 0">
      Cycle: <strong>5s Lobby</strong> → <strong>6-round Match</strong> → <strong>5s Lobby</strong> …  
      Place your bet during the lobby to join the next match.
    </p>
  </div>

  <!-- Arena -->
  <div class="panel" id="arenaPanel" style="display:none">
    <div class="hud">
      <div class="row">
        <div class="stat"><span class="k">Wallet</span><span class="v" id="walletHud">—</span></div>
        <div class="pill" id="cyclePill">Join window: 5.0s</div>
        <div class="pill" id="roundPill">Round – / 6</div>
      </div>
    </div>

    <div class="timerbar"><div class="timerfill" id="timerFill"></div></div>
    <div class="timeText" id="timeText">Round time left: —</div>

    <div class="arenaWrap" id="arenaWrap">
      <div class="arena">
        <!-- LEFT -->
        <div class="card wiggle" data-side="left">
          <div class="inner">
            <div class="edgeF edge-red"></div>
            <div class="edgeB edge-red"></div>
            <div class="face front">TAP TO REVEAL</div>
            <div class="face back"><span class="backText"></span></div>
          </div>
          <div class="label">Red Card</div>
        </div>
        <!-- RIGHT -->
        <div class="card wiggle" data-side="right">
          <div class="inner">
            <div class="edgeF edge-blue"></div>
            <div class="edgeB edge-blue"></div>
            <div class="face front">TAP TO REVEAL</div>
            <div class="face back"><span class="backText"></span></div>
          </div>
          <div class="label">Blue Card</div>
        </div>
      </div>
    </div>

    <!-- Bet box -->
    <div class="betBox" id="betBox">
      <div class="seg">
        <div class="tabs">
          <button class="on" id="tabBet">Bet</button>
          <button id="tabAuto" disabled>Auto</button>
        </div>
        <div class="mini" title="Collapse"></div>
      </div>

      <div class="betGrid">
        <div>
          <div class="qty">
            <button class="roundBtn" id="minusBtn">−</button>
            <div class="amount" id="amountView">1.00</div>
            <button class="roundBtn" id="plusBtn">+</button>
          </div>
          <div class="chips">
            <button class="chip" data-chip="1">1</button>
            <button class="chip" data-chip="2">2</button>
            <button class="chip" data-chip="5">5</button>
            <button class="chip" data-chip="10">10</button>
          </div>
        </div>
        <div class="betMain">
          <button class="betBtn" id="betBtn">Bet<span id="betBtnAmount">1.00 GEL</span></button>
        </div>
      </div>
      <div class="betNote" id="betNote"></div>
    </div>

    <!-- Cash-out box -->
    <div class="cashBox" id="cashBox" style="display:none">
      <div class="cashMain">
        <button class="bigBtn bigPrimary" id="fullCashBtn">
          CASH OUT
          <span class="small" id="fullAmt">0.00 GEL</span>
        </button>
        <button class="bigBtn bigHalf" id="halfCashBtn">
          CASH OUT 50%
          <span class="small" id="halfAmt">0.00 GEL</span>
        </button>
      </div>
      <div class="betNote" id="cashNote">50% unlocks from Round 4.</div>
    </div>
  </div>
</div>

<script>
(()=>{
  // ====== Config ======
  const BASE_WALLET = 1500;
  const TOTAL_ROUNDS = 6;
  const BONUS_ROUND  = 6;
  const ROUND_TIME = 6.0;
  const PICK_WINDOW = 3.0;
  const REVEAL_AT   = 3.0;
  const LOBBY_TIME  = 5.0;

  const MULTS = [
    {x:1.2, w:0.30},{x:1.5, w:0.22},{x:2.0, w:0.18},
    {x:3.0, w:0.12},{x:5.0, w:0.08},{x:7.0, w:0.06},{x:10.0,w:0.04}
  ];
  const RTP_TARGET = 1.50;
  const AVG_MULT = MULTS.reduce((s,m)=>s+m.x*m.w,0);
  const TRAP_PROB = Math.min(1, Math.max(0, 1 - (RTP_TARGET / AVG_MULT)));

  // ====== State ======
  let wallet = BASE_WALLET;
  let inLobby = true, lobbyLeft = LOBBY_TIME;
  let round = 0, canPick=false, picked=false, chosen=null, board=[null,null], outcome=null;
  let joinedCurrent=false;                // joined THIS match
  let prebet=1;                           // stake chosen in bet bar (lobby)
  let queuedNext=0;                       // queued bet for next match (deducted now)
  let current = 0;                        // current running total if joined
  // timers
  let tLobby=null,tRound=null,tReveal=null,tLock=null,tEnd=null;

  // audio
  let ac=null,gain=null,musicInt=null,muted=false;
  function ensureAudio(){
    if(ac) return;
    ac=new (window.AudioContext||window.webkitAudioContext)();
    gain=ac.createGain(); gain.gain.value=.5; gain.connect(ac.destination);
  }
  function sfx(type){
    if(!ac||muted) return;
    const now=ac.currentTime;
    if(type==='click'){
      const o=ac.createOscillator(), g=ac.createGain(); o.type='square'; o.frequency.value=600;
      g.gain.value=.25; g.gain.exponentialRampToValueAtTime(0.0001,now+.08);
      o.connect(g).connect(gain); o.start(now); o.stop(now+.1);
    }else if(type==='win'){
      const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.setValueAtTime(440,now);
      o.frequency.exponentialRampToValueAtTime(880,now+.25);
      g.gain.setValueAtTime(.001,now); g.gain.exponentialRampToValueAtTime(.4,now+.02);
      g.gain.exponentialRampToValueAtTime(.0001,now+.35);
      o.connect(g).connect(gain); o.start(now); o.stop(now+.4);
    }else if(type==='crash'){
      const b=ac.createBuffer(1,ac.sampleRate*.3,ac.sampleRate), d=b.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5);
      const s=ac.createBufferSource(); s.buffer=b; const g=ac.createGain(); g.gain.value=.45; g.gain.exponentialRampToValueAtTime(.0001,now+.3);
      const f=ac.createBiquadFilter(); f.type='lowpass'; f.frequency.value=2200; s.connect(f).connect(g).connect(gain); s.start(now);
    }else if(type==='coin'){
      [880,1320,1760].forEach((f,i)=>{const o=ac.createOscillator(), g=ac.createGain(); o.type='square';
        o.frequency.setValueAtTime(f,now+i*.03); g.gain.setValueAtTime(.18,now+i*.03); g.gain.exponentialRampToValueAtTime(.0001,now+i*.03+.12);
        o.connect(g).connect(gain); o.start(now+i*.03); o.stop(now+i*.03+.14);});
    }
  }
  function startMusic(){
    if(musicInt||muted||!ac) return;
    const seq=[220,220,277,220,330,220,196,220]; let i=0;
    musicInt=setInterval(()=>{ if(muted||!ac) return;
      const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=seq[i%seq.length]; g.gain.value=.06;
      o.connect(g).connect(gain); o.start(); o.stop(ac.currentTime+.18); i++; },220);
  }
  function stopMusic(){ if(musicInt){clearInterval(musicInt); musicInt=null;} }

  // ====== DOM ======
  const $=id=>document.getElementById(id);
  const lobbyPanel=$('lobbyPanel'), arenaPanel=$('arenaPanel');
  const walletTop=$('walletTop'), walletHud=$('walletHud'), cyclePill=$('cyclePill'), roundPill=$('roundPill'), timerFill=$('timerFill'), timeText=$('timeText'), arenaWrap=$('arenaWrap');
  const enterBtn=$('enterBtn');
  const cards=[...document.querySelectorAll('.card')];
  const amountView=$('amountView'), betBtn=$('betBtn'), betBtnAmount=$('betBtnAmount'), betNote=$('betNote'), betBox=$('betBox');
  const minusBtn=$('minusBtn'), plusBtn=$('plusBtn'); document.querySelectorAll('.chip').forEach(c=>c.onclick=()=>setBet(Number(c.dataset.chip)));
  const cashBox=$('cashBox'), fullCashBtn=$('fullCashBtn'), halfCashBtn=$('halfCashBtn'), fullAmt=$('fullAmt'), halfAmt=$('halfAmt');

  // ====== Helpers ======
  const fmt = n => (Math.round(n*100)/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const show = (el,on=true)=> el.style.display = on?'block':'none';
  function showOnly(panel){ show(lobbyPanel,false); show(arenaPanel,false); show(panel,true); window.scrollTo({top:0,behavior:'instant'}); }
  function updateWallet(){ walletTop.textContent = fmt(wallet)+' GEL'; walletHud.textContent = fmt(wallet)+' GEL'; }

  function sampleWeighted(){ const r=Math.random(); let acc=0; for(const m of MULTS){acc+=m.w; if(r<=acc) return m.x;} return MULTS.at(-1).x; }
  function normalOutcome(){ return (Math.random()<TRAP_PROB) ? {type:'trap'} : {type:'mult',x:sampleWeighted()}; }
  function makeBoard(r){ if(r===BONUS_ROUND){ const a=[{type:'mult',x:1},{type:'mult',x:2}]; if(Math.random()<.5) a.reverse(); return a; } return [normalOutcome(), normalOutcome()]; }

  // ====== UI Switchers ======
  function showBetBox(){ show(betBox,true); show(cashBox,false); }
  function showCashBox(){ show(betBox,false); show(cashBox,true); }

  function refreshCashBox(){
    fullAmt.textContent = fmt(current)+' GEL';
    halfAmt.textContent = fmt(current/2)+' GEL';
    // 50% from round 4 only
    const lockHalf = (round < 4) || current<=0;
    halfCashBtn.classList.toggle('cashDisabled', lockHalf);
  }

  function setBet(v){ prebet=Math.max(1,Math.min(1e6,v)); refreshBetBar(); }
  function refreshBetBar(){
    amountView.textContent = prebet.toFixed(2);
    betBtnAmount.textContent = `${prebet.toFixed(2)} GEL`;
    if(inLobby){
      const enough = wallet>=prebet;
      betBtn.classList.toggle('disabled', !enough);
      betBox.classList.toggle('disabled', !enough);
      betNote.textContent = enough ? 'Place your bet to join the upcoming match.' : 'You can spectate, but need funds to bet.';
    }else{
      // in match: you can pre-bet toggle if you are NOT joined
      const spectating = !joinedCurrent;
      const queued = queuedNext>0;
      betBtn.classList.toggle('disabled', false);
      betBox.classList.toggle('disabled', false);
      betBtn.textContent = queued ? 'Cancel queued bet' : 'Bet';
      betBtn.innerHTML = (queued ? 'Cancel queued bet' : 'Bet') + `<span>${prebet.toFixed(2)} GEL${queued?' (queued)':''}</span>`;
      betNote.textContent = spectating
        ? (queued ? 'Queued for the next match. Tap again to cancel.' : 'Spectating: queue a bet for the next match.')
        : 'You are in this match — use cash out.';
    }
  }

  // ====== Cards ======
  function resetCards(isBonus){
    cards.forEach(c=>{
      c.className='card wiggle';
      const inner=c.querySelector('.inner'); inner.classList.remove('flip');
      const left = (c.dataset.side==='left');
      inner.querySelector('.edgeF').className = 'edgeF '+(isBonus?'edge-gold':(left?'edge-red':'edge-blue'));
      inner.querySelector('.edgeB').className = 'edgeB '+(isBonus?'edge-gold':(left?'edge-red':'edge-blue'));
      c.querySelector('.backText').textContent='';
      c.querySelector('.label').textContent = isBonus ? 'Bonus Card' : (left?'Red Card':'Blue Card');
      if(isBonus) c.classList.add('bonus');
      c.style.pointerEvents = canPick ? 'auto' : 'none';
    });
    chosen=null; picked=false; outcome=null;
  }
  cards.forEach(c=>c.addEventListener('click', ()=>{ if(!canPick||picked) return; pick(c); }));
  function pick(card){
    picked=true; chosen=card; sfx('click');
    const other = cards.find(x=>x!==card);
    cards.forEach(c=> c.classList.remove('wiggle'));
    card.classList.add('picked'); if(other) other.classList.add('shrunk');
  }
  function revealChosen(){
    if(!chosen) return;
    const side = chosen.dataset.side==='left'?0:1, other=1-side;
    chosen.classList.add('flip');
    const c = board[side];
    if(c.type==='trap' && round!==BONUS_ROUND){
      chosen.classList.add('trap'); chosen.querySelector('.backText').textContent='×';
      outcome='trap'; sfx('crash');
      // lose bet, become spectator
      current = 0; joinedCurrent=false; arenaWrap.classList.add('spectate');
      // switch back to bet box (pre-bet) since no longer in match
      showBetBox(); refreshBetBar();
    }else{
      const mult = c.x;
      chosen.classList.add('success'); chosen.querySelector('.backText').textContent=`${mult}×`;
      outcome='win'; sfx('win');
      current = +(current * mult).toFixed(2);
      refreshCashBox();
    }
    const otherEl = cards[other]; otherEl.classList.add('flip');
    const oc = board[other]; otherEl.querySelector('.backText').textContent = (round===BONUS_ROUND ? `${oc.x}×` : (oc.type==='trap'?'×':`${oc.x}×`));
  }

  // ====== Cycle ======
  function startLobby(){
    inLobby=true; lobbyLeft=LOBBY_TIME; round=0;
    cyclePill.textContent = `Join window: ${lobbyLeft.toFixed(1)}s`;
    timerFill.style.transform='scaleX(1)';
    timeText.textContent = 'Round time left: —';
    arenaWrap.classList.add('spectate'); // not in a match yet
    showBetBox(); refreshBetBar();
    clearTimers();

    tLobby=setInterval(()=>{
      lobbyLeft=Math.max(0,lobbyLeft-0.1);
      cyclePill.textContent = `Join window: ${lobbyLeft.toFixed(1)}s`;
      timerFill.style.transform=`scaleX(${Math.max(0,lobbyLeft/LOBBY_TIME)})`;
      if(lobbyLeft<=0.01){ clearInterval(tLobby); startMatch(); }
    },100);
  }

  function startMatch(){
    inLobby=false;
    ensureAudio(); startMusic();

    // apply queued bet if any
    if(queuedNext>0){
      current = queuedNext; queuedNext=0;
      joinedCurrent=true; arenaWrap.classList.remove('spectate');
      showCashBox(); refreshCashBox();
    }else{
      joinedCurrent=false; current=0; arenaWrap.classList.add('spectate');
      showBetBox(); refreshBetBar();
    }
    nextRound();
  }

  function nextRound(){
    round++; if(round> TOTAL_ROUNDS){ stopMusic(); startLobby(); return; }

    canPick = joinedCurrent; // only joined players can pick
    board = makeBoard(round);
    resetCards(round===BONUS_ROUND);
    roundPill.textContent = `Round ${round} / ${TOTAL_ROUNDS}`;
    // if newly joined at match start, current already set to stake; otherwise spectating.

    // timers per round
    clearRoundTimers();
    tLock = setTimeout(()=>{ canPick=false; cards.forEach(c=>c.style.pointerEvents='none'); }, PICK_WINDOW*1000);
    tReveal = setTimeout(()=>{ if(picked) revealChosen(); }, REVEAL_AT*1000);
    tEnd = setTimeout(()=>{ nextRound(); }, ROUND_TIME*1000);

    // visual round timer + text
    const t0 = performance.now();
    if (tRound) clearInterval(tRound);
    tRound=setInterval(()=>{
      const left=Math.max(0, ROUND_TIME - (performance.now()-t0)/1000);
      timerFill.style.transform=`scaleX(${Math.max(0,left/ROUND_TIME)})`;
      timeText.textContent = `Round time left: ${left.toFixed(1)}s`;
      if(left<=0.01){ clearInterval(tRound); }
    },100);
  }

  function clearRoundTimers(){ [tRound,tReveal,tLock,tEnd].forEach(t=>t&&clearInterval(t)); [tReveal,tLock,tEnd]=[tReveal,tLock,tEnd].map(t=>{ if(t) clearTimeout(t); return null; }); tRound=null; }
  function clearTimers(){ if(tLobby){clearInterval(tLobby); tLobby=null;} clearRoundTimers(); }

  // ====== Cash-out actions ======
  fullCashBtn.onclick = ()=>{
    if(!joinedCurrent || current<=0) return;
    sfx('coin'); wallet += current; updateWallet();
    // leave match → spectator
    joinedCurrent=false; current=0; arenaWrap.classList.add('spectate');
    showBetBox(); refreshBetBar();
  };
  halfCashBtn.onclick = ()=>{
    if(!joinedCurrent || current<=0 || round<4) return;
    sfx('coin');
    const half = +(current/2).toFixed(2);
    wallet += half; current = +(current - half).toFixed(2);
    updateWallet(); refreshCashBox();
  };

  // ====== Bet actions ======
  minusBtn.onclick=()=> setBet(prebet-1);
  plusBtn.onclick =()=> setBet(prebet+1);
  betBtn.onclick = ()=>{
    if(inLobby){
      // queue for the *immediately upcoming* match
      if(wallet<prebet){ refreshBetBar(); return; }
      wallet -= prebet; queuedNext = prebet; updateWallet();
      betNote.textContent = `You're in! Stake ${prebet.toFixed(2)} GEL for the next match.`;
      refreshBetBar();
    }else{
      // in match: toggle pre-bet for next match (spectators only)
      if(joinedCurrent) return; // joined players use cash out
      if(queuedNext>0){
        // cancel & refund
        wallet += queuedNext; queuedNext = 0; updateWallet();
        betNote.textContent = 'Queued bet cancelled and refunded.';
      }else{
        if(wallet<prebet){ betNote.textContent='Not enough funds to queue.'; return; }
        wallet -= prebet; queuedNext = prebet; updateWallet();
        betNote.textContent = `Queued ${prebet.toFixed(2)} GEL for the next match. Tap again to cancel.`;
      }
      refreshBetBar();
    }
  };

  // ====== Navigation ======
  function init(){
    wallet = BASE_WALLET; updateWallet(); setBet(1);
    showOnly(lobbyPanel);
  }
  $('enterBtn').onclick = ()=>{ showOnly(arenaPanel); updateWallet(); startLobby(); };

  // ====== Boot ======
  init();
})();
</script>
</body>
</html>
