<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>vortoX — Two-Card Multiplayer Prototype</title>
<style>
  :root{
    --bg:#0b0b0b; --text:#f5f5f5; --muted:#a0a6ad;
    --panel:#121212; --edge:#222; --card:#0e0f10;
    --accent:#25c05a; --accent-dark:#1ea14a;
    --red:#e53935; --blue:#1e88e5; --gold:#f7c948;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:18px 14px}

  .brand{display:flex;justify-content:center;align-items:center;margin:6px 0 10px}
  .brand .name{font-weight:900;font-size:26px;letter-spacing:.2px}
  .brand .name .x{color:#5cf27e}
  .badge{margin-left:8px;background:#1c1c1c;border:1px solid #2b2b2b;border-radius:999px;padding:2px 8px;font-size:11px;color:#a7d8b4;font-weight:800}

  .panel{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:12px;margin-bottom:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .stat{background:#0f0f0f;border:1px solid #242424;border-radius:12px;padding:8px 10px;min-width:130px}
  .stat .k{display:block;font-size:12px;color:#c7c7c7}
  .stat .v{display:block;font-weight:900;font-size:18px}

  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:800}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:#1b1b1b;border:1px solid #333;color:#e7e7e7}
  .btn-danger{background:#2a1a1a;border:1px solid #552; color:#ffdede}

  .hud{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .pill{background:#0f0f0f;border:1px solid #242424;border-radius:999px;padding:6px 10px;font-weight:800}
  .iconBtn{width:40px;height:40px;border-radius:12px;border:1px solid #333;background:#1b1b1b;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .iconBtn svg{width:20px;height:20px;fill:#fff;opacity:.9}
  .iconBtn.muted svg{opacity:.35}

  .timerbar{height:12px;background:#161616;border:1px solid #2b2b2b;border-radius:999px;overflow:hidden}
  .timerfill{height:100%;width:100%;background:linear-gradient(90deg,#4caf50,#8bc34a);transform-origin:left;transform:scaleX(1)}
  .timeText{margin-top:6px;text-align:center;font-size:13px;color:#d9d9d9}

  .arenaWrap{position:relative}
  .arenaWrap.spectate{opacity:.5}
  .arena{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:12px 0}
  .card{
    position:relative;aspect-ratio:3/5;border-radius:16px;user-select:none;cursor:pointer;
    background:var(--card);
    transform:scale(.60); transition:transform .28s ease,background .2s ease, box-shadow .2s ease, opacity .2s ease;
    perspective:1000px;
  }
  .arenaWrap.lobby .card{opacity:0} /* hide cards during 5s waiting */
  .card.wiggle{animation:wiggle 1.3s ease-in-out infinite}
  @keyframes wiggle {0%{transform:scale(.58)}50%{transform:scale(.62)}100%{transform:scale(.58)}}
  .card.picked{animation:none; transform:scale(1)}
  .card.shrunk{animation:none !important; transform:scale(.60) !important}

  .inner{position:absolute;inset:0;border-radius:16px; transform-style:preserve-3d; transition:transform .55s ease}
  .flip .inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:16px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden}
  .front{
    background:
      radial-gradient(120% 120% at 100% 0%, rgba(255,255,255,.05), transparent 40%),
      linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0));
    color:#eaeaea; font-weight:800; letter-spacing:.06em;
  }
  .back{ transform:rotateY(180deg); font-size:44px; font-weight:900; color:#fff; display:flex;align-items:center;justify-content:center }

  .edgeF,.edgeB{ position:absolute;inset:0;border-radius:16px;border:2px dashed #2a2a2a; pointer-events:none }
  .edgeB{transform:rotateY(180deg)}
  .edge-red{border-color:#e53935} .edge-blue{border-color:#1e88e5} .edge-gold{border-color:#f7c948}
  .label{position:absolute;bottom:8px;left:0;right:0;text-align:center;color:#dcdcdc;font-size:13px}

  .success .back{background:linear-gradient(180deg, rgba(37,192,90,.36), rgba(37,192,90,.16));}
  .trap .back{background:linear-gradient(180deg, rgba(255,59,48,.36), rgba(255,59,48,.16));}
  .bonus .front{box-shadow:0 0 0 1px rgba(255,214,80,.3) inset}
  .bonus .back{background:linear-gradient(180deg, rgba(255,220,120,.28), rgba(255,204,72,.14));}
  .bonusGlow{box-shadow:0 0 24px rgba(247,201,72,.55), inset 0 0 12px rgba(247,201,72,.35)}

  /* Bet box */
  .betBox{background:#0f0f0f;border:1px solid #242424;border-radius:16px;padding:10px;margin-top:10px}
  .seg{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .seg .tabs{display:flex;background:#1a1a1a;border:1px solid #333;border-radius:999px;overflow:hidden}
  .seg .tabs button{background:transparent;color:#cfcfcf;padding:8px 16px;border:0;font-weight:800}
  .seg .tabs .on{background:#2a2a2a;color:#fff}

  .betGrid{display:grid;grid-template-columns:260px 1fr;gap:12px}
  .qty{display:grid;grid-template-columns:46px 1fr 46px;gap:8px;align-items:center}
  .roundBtn{height:46px;border-radius:24px;background:#1a1a1a;border:1px solid #333;color:#eee;font-size:20px;font-weight:900}
  .amount{height:46px;display:flex;align-items:center;justify-content:center;background:#0f0f0f;border:1px solid #2b2b2b;border-radius:14px}
  .amount input{width:100%;text-align:center;background:transparent;border:0;outline:none;color:#fff;font-weight:900;font-size:20px;-moz-appearance:textfield}
  .amount input::-webkit-outer-spin-button,.amount input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  .chips{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  .chip{height:42px;background:#1b1b1b;border:1px solid #333;border-radius:12px;color:#eee;font-weight:800}

  .betActions{display:flex;gap:10px;align-items:center}
  .betMain{flex:1;display:flex;align-items:center}
  .betBtn{width:100%;height:116px;border-radius:16px;background:var(--accent);color:#07190e;border:0;font-weight:900;font-size:28px;line-height:1.1}
  .betBtn span{display:block;font-size:20px;margin-top:6px;opacity:.95}
  .cancelBtn{height:116px;border-radius:16px;padding:0 14px}
  .disabled{opacity:.45;pointer-events:none}
  .betNote{margin-top:6px;color:var(--muted);font-size:12px;text-align:center}

  /* Cash-out single button */
  .cashBox{background:#0f0f0f;border:1px solid #242424;border-radius:16px;padding:10px;margin-top:10px}
  .bigBtn{width:100%;padding:18px;border-radius:16px;font-weight:900;background:var(--accent);color:#07190e;font-size:24px}
  .bigBtn .small{display:block;font-size:16px;opacity:.95}
  .cashDisabled{opacity:.45;pointer-events:none}

  /* Local overlays */
  .overlayLocal{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.55));
    z-index:10; pointer-events:none;
  }
  .overlayLocal .num{font-size:18vmin;font-weight:1000;letter-spacing:.04em}

  .bonusSplash{
    background: linear-gradient(180deg,#ffe88a,#f7c948,#ffdd73);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow: 0 0 18px rgba(247,201,72,.55), 0 0 36px rgba(247,201,72,.35);
    font-size:12vmin; font-weight:1000; letter-spacing:.08em
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <div class="name">vorto<span class="x">X</span></div>
    <span class="badge">v31c</span>
  </div>

  <!-- LOBBY -->
  <div class="panel" id="lobbyPanel">
    <div class="row">
      <div class="stat"><span class="k">Wallet</span><span class="v" id="walletTop">1,500.00 GEL</span></div>
      <button class="btn btn-ghost" id="enterBtn">Enter Arena</button>
    </div>
    <p class="muted" style="margin:6px 0 0">
      Cycle: <strong>5s Lobby</strong> → <strong>6-round Match</strong> → <strong>5s Lobby</strong>.  
      Place your bet during the lobby to join the next match.
    </p>
  </div>

  <!-- ARENA -->
  <div class="panel" id="arenaPanel" style="display:none">
    <div class="hud">
      <div class="row" style="gap:8px;align-items:center">
        <div class="stat"><span class="k">Wallet</span><span class="v" id="walletHud">1,500.00 GEL</span></div>
        <div class="pill" id="cyclePill">Join window: 5.0s</div>
        <div class="pill" id="roundPill">Round – / 6</div>
      </div>
      <div class="iconBtn" id="musicBtn" title="Toggle music">
        <svg viewBox="0 0 24 24"><path d="M3 10v4h4l5 4V6L7 10H3zm13 2a3 3 0 0 0-2.12-2.83v5.66A3 3 0 0 0 16 12zm0-7a7 7 0 0 1 0 14v-2a5 5 0 0 0 0-10V5z"/></svg>
      </div>
    </div>

    <div class="timerbar"><div class="timerfill" id="timerFill"></div></div>
    <div class="timeText" id="timeText">Round time left: —</div>

    <div class="arenaWrap" id="arenaWrap">
      <div class="overlayLocal" id="prepOverlay"><div class="num" id="prepNum">5</div></div>
      <div class="overlayLocal" id="bonusOverlay" style="display:none"><div class="bonusSplash">BONUS ROUND</div></div>

      <div class="arena">
        <!-- LEFT -->
        <div class="card wiggle" data-side="left">
          <div class="inner">
            <div class="edgeF edge-red"></div>
            <div class="edgeB edge-red"></div>
            <div class="face front">TAP TO REVEAL</div>
            <div class="face back"><span class="backText"></span></div>
          </div>
          <div class="label">Red Card</div>
        </div>
        <!-- RIGHT -->
        <div class="card wiggle" data-side="right">
          <div class="inner">
            <div class="edgeF edge-blue"></div>
            <div class="edgeB edge-blue"></div>
            <div class="face front">TAP TO REVEAL</div>
            <div class="face back"><span class="backText"></span></div>
          </div>
          <div class="label">Blue Card</div>
        </div>
      </div>
    </div>

    <!-- Bet panel -->
    <div class="betBox" id="betBox">
      <div class="seg">
        <div class="tabs"><button class="on" id="tabBet">Bet</button><button id="tabAuto" disabled>Auto</button></div>
      </div>
      <div class="betGrid">
        <div>
          <div class="qty">
            <button class="roundBtn" id="minusBtn">−</button>
            <div class="amount"><input id="amountInput" type="number" step="0.01" min="1" value="10.00" inputmode="decimal" /></div>
            <button class="roundBtn" id="plusBtn">+</button>
          </div>
          <div class="chips">
            <button class="chip" data-chip="1">1</button>
            <button class="chip" data-chip="2">2</button>
            <button class="chip" data-chip="5">5</button>
            <button class="chip" data-chip="10">10</button>
          </div>
        </div>
        <div class="betActions">
          <div class="betMain">
            <button class="betBtn" id="betBtn">Bet<span id="betBtnAmount">10.00 GEL</span></button>
          </div>
          <button class="btn btn-danger cancelBtn" id="cancelQueueBtn" style="display:none">Cancel</button>
        </div>
      </div>
      <div class="betNote" id="betNote"></div>
    </div>

    <!-- Cash-out (single) -->
    <div class="cashBox" id="cashBox" style="display:none">
      <button class="bigBtn" id="fullCashBtn">CASH OUT <span class="small" id="fullAmt">0.00 GEL</span></button>
      <div class="betNote" id="cashNote">Cash Out becomes available after your chosen card is revealed.</div>
    </div>
  </div>
</div>

<script>
(()=>{
  // ===== CONFIG =====
  const BASE_WALLET = 1500;
  const TOTAL_ROUNDS = 6, BONUS_ROUND = 6;
  const ROUND_TIME = 6, PICK_WINDOW = 3, REVEAL_AT = 3, LOBBY_TIME = 5;

  const MULTS = [
    {x:1.2,w:.30},{x:1.5,w:.22},{x:2.0,w:.18},
    {x:3.0,w:.12},{x:5.0,w:.08},{x:7.0,w:.06},{x:10.0,w:.04}
  ];
  const RTP_TARGET = 2.00; // 200%
  const AVG_MULT = MULTS.reduce((s,m)=>s+m.x*m.w,0);
  const TRAP_PROB = Math.min(.95, Math.max(0, 1 - (RTP_TARGET/AVG_MULT)));

  // ===== STATE =====
  let wallet = BASE_WALLET;
  let inLobby = true, lobbyLeft = LOBBY_TIME;
  let round = 0, canPick=false, picked=false, chosen=null, board=[null,null];
  let joinedCurrent=false, prebet=10, queuedNext=0, current=0;
  let canCashOut=false;    // <— NEW: unlocked only after your reveal
  // timers
  let tLobbyInt=null,tRound=null,tReveal=null,tLock=null,tEnd=null;

  // ===== AUDIO (short) =====
  let ac=null,gain=null,musicInt=null,muted=false,primed=false;
  const ensureAudio=()=>{ if(ac) return; ac=new (window.AudioContext||window.webkitAudioContext)(); gain=ac.createGain(); gain.gain.value=.5; gain.connect(ac.destination); };
  function sfx(type){ if(!ac||muted) return; const now=ac.currentTime;
    if(type==='win'){const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.setValueAtTime(440,now); o.frequency.exponentialRampToValueAtTime(880,now+.25); g.gain.setValueAtTime(.001,now); g.gain.exponentialRampToValueAtTime(.4,now+.02); g.gain.exponentialRampToValueAtTime(.0001,now+.35); o.connect(g).connect(gain); o.start(now); o.stop(now+.4);}
    else if(type==='crash'){const b=ac.createBuffer(1,ac.sampleRate*.3,ac.sampleRate), d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5); const s=ac.createBufferSource(); s.buffer=b; const g=ac.createGain(); g.gain.value=.45; g.gain.exponentialRampToValueAtTime(.0001,now+.3); s.connect(g).connect(gain); s.start(now);}
    else if(type==='coin'){[880,1320,1760].forEach((f,i)=>{const o=ac.createOscillator(), g=ac.createGain(); o.type='square'; o.frequency.setValueAtTime(f,now+i*.03); g.gain.setValueAtTime(.18,now+i*.03); g.gain.exponentialRampToValueAtTime(.0001,now+i*.03+.12); o.connect(g).connect(gain); o.start(now+i*.03); o.stop(now+i*.03+.14);});}
  }
  const startMusic=()=>{ if(!ac||muted||musicInt) return; const seq=[220,220,277,220,330,220,196,220]; let i=0; musicInt=setInterval(()=>{ if(muted||!ac) return; const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=seq[i%seq.length]; g.gain.value=.06; o.connect(g).connect(gain); o.start(); o.stop(ac.currentTime+.18); i++; },220); };
  const stopMusic=()=>{ if(musicInt){clearInterval(musicInt); musicInt=null;} }

  // ===== DOM =====
  const $=id=>document.getElementById(id);
  const lobbyPanel=$('lobbyPanel'), arenaPanel=$('arenaPanel');
  const walletTop=$('walletTop'), walletHud=$('walletHud'), cyclePill=$('cyclePill'), roundPill=$('roundPill'), timerFill=$('timerFill'), timeText=$('timeText'), arenaWrap=$('arenaWrap');
  const enterBtn=$('enterBtn'), musicBtn=$('musicBtn');
  const prepOverlay=$('prepOverlay'), prepNum=$('prepNum'), bonusOverlay=$('bonusOverlay');

  const cards=[...document.querySelectorAll('.card')];
  const amountInput=$('amountInput'), betBtn=$('betBtn'), betBtnAmount=$('betBtnAmount'), betNote=$('betNote'), betBox=$('betBox');
  const minusBtn=$('minusBtn'), plusBtn=$('plusBtn'), cancelQueueBtn=$('cancelQueueBtn');
  document.querySelectorAll('.chip').forEach(c=>c.onclick=()=>setBet(Number(c.dataset.chip)));
  const cashBox=$('cashBox'), fullCashBtn=$('fullCashBtn'), fullAmt=$('fullAmt');

  // ===== UTIL =====
  const fmt = n => (Math.round(n*100)/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const show = (el,on=true)=> el.style.display = on?'block':'none';
  const showOnly = panel => { show(lobbyPanel,false); show(arenaPanel,false); show(panel,true); window.scrollTo({top:0,behavior:'instant'}); };
  function updateWallet(){ const t=fmt(wallet)+' GEL'; walletTop.textContent=t; walletHud.textContent=t; }

  function sampleWeighted(){ const r=Math.random(); let acc=0; for(const m of MULTS){acc+=m.w; if(r<=acc) return m.x;} return MULTS.at(-1).x; }
  const normalOutcome = () => (Math.random()<TRAP_PROB) ? {type:'trap'} : {type:'mult',x:sampleWeighted()};
  function makeBoard(r){ if(r===BONUS_ROUND){ const a=[{type:'mult',x:1},{type:'mult',x:2}]; if(Math.random()<.5) a.reverse(); return a; } return [normalOutcome(), normalOutcome()]; }

  const showBetBox=()=>{ show(betBox,true); show(cashBox,false); };
  const showCashBox=()=>{ show(betBox,false); show(cashBox,true); };
  const refreshCashBtn=()=>{ fullAmt.textContent=fmt(current)+' GEL'; fullCashBtn.classList.toggle('cashDisabled', !canCashOut || current<=0 || !joinedCurrent); };

  function setBet(v){ prebet=Math.max(1,Math.min(1e9,Number(v)||1)); amountInput.value=prebet.toFixed(2); betBtnAmount.textContent=`${prebet.toFixed(2)} GEL`; refreshBetHelp(); }
  function refreshBetHelp(){
    if(inLobby){
      const enough=wallet>=prebet;
      betBtn.classList.toggle('disabled',!enough);
      betBox.classList.toggle('disabled',!enough);
      cancelQueueBtn.style.display='none';
      betNote.textContent=enough?'Place your bet to join the upcoming match.':'You can spectate, but need funds to bet.';
    }else{
      const queued=queuedNext>0;
      betBtn.classList.remove('disabled');
      betBox.classList.remove('disabled');
      betBtn.textContent=queued?'Queued':'Bet';
      betBtn.innerHTML=(queued?'Queued':'Bet')+`<span>${prebet.toFixed(2)} GEL${queued?' (next match)':''}</span>`;
      cancelQueueBtn.style.display=queued?'block':'none';
      betNote.textContent=!joinedCurrent?(queued?'Tap cancel to unqueue.':'Spectating: queue a bet for the next match.'):'You are in this match — use cash out.';
    }
  }

  function resetCards(isBonus){
    cards.forEach(c=>{
      c.className='card wiggle';
      const inner=c.querySelector('.inner'); inner.classList.remove('flip');
      const left=(c.dataset.side==='left');
      inner.querySelector('.edgeF').className='edgeF '+(isBonus?'edge-gold':(left?'edge-red':'edge-blue'));
      inner.querySelector('.edgeB').className='edgeB '+(isBonus?'edge-gold':(left?'edge-red':'edge-blue'));
      c.querySelector('.backText').textContent='';
      c.querySelector('.label').textContent=isBonus?'Bonus Card':(left?'Red Card':'Blue Card');
      c.classList.toggle('bonus',isBonus); c.classList.toggle('bonusGlow',isBonus);
      c.style.pointerEvents=canPick?'auto':'none';
    });
    chosen=null; picked=false;
  }
  cards.forEach(c=>c.addEventListener('click',()=>{ if(!canPick||picked) return; picked=true; chosen=c; const other=cards.find(x=>x!==c); cards.forEach(k=>k.classList.remove('wiggle')); c.classList.add('picked'); if(other) other.classList.add('shrunk'); }));

  const textFor=(o,isBonus)=> isBonus?`${o.x}×`:(o.type==='trap'?'×':`${o.x}×`);
  function revealBoth(){ const [L,R]=cards; L.classList.add('flip'); R.classList.add('flip'); L.querySelector('.backText').textContent=textFor(board[0],round===BONUS_ROUND); R.querySelector('.backText').textContent=textFor(board[1],round===BONUS_ROUND); }
  function revealChosen(){
    // lock cashout until reveal is processed
    canCashOut=false; refreshCashBtn();
    if(!chosen){ revealBoth(); return; }
    const side=chosen.dataset.side==='left'?0:1, other=1-side;
    chosen.classList.add('flip');
    const c=board[side];
    if(c.type==='trap' && round!==BONUS_ROUND){
      chosen.classList.add('trap'); chosen.querySelector('.backText').textContent='×';
      sfx('crash'); current=0; joinedCurrent=false; canCashOut=false; arenaWrap.classList.add('spectate'); showBetBox(); refreshBetHelp(); refreshCashBtn();
    }else{
      const mult=c.x; chosen.classList.add('success'); chosen.querySelector('.backText').textContent=`${mult}×`;
      sfx('win'); current=+(current*mult).toFixed(2);
      canCashOut=true;               // <— enable cash out only AFTER reveal
      refreshCashBtn();
      showCashBox();
    }
    const otherEl=cards[other]; otherEl.classList.add('flip'); otherEl.querySelector('.backText').textContent=textFor(board[other],round===BONUS_ROUND);
  }

  function localCountdown(seconds,onDone){
    prepOverlay.style.display='flex'; arenaWrap.classList.add('lobby');
    let t=seconds; prepNum.textContent=Math.ceil(t);
    const it=setInterval(()=>{ t-=1; prepNum.textContent=Math.max(0,Math.ceil(t)); if(t<=0){ clearInterval(it); prepOverlay.style.display='none'; arenaWrap.classList.remove('lobby'); onDone&&onDone(); } },1000);
  }
  const bonusSplash = onDone => { bonusOverlay.style.display='flex'; setTimeout(()=>{ bonusOverlay.style.display='none'; onDone&&onDone(); },2000); };

  // ===== FLOW =====
  function startLobby(){
    inLobby=true; round=0; lobbyLeft=LOBBY_TIME; updateWallet();
    cyclePill.textContent=`Join window: ${lobbyLeft.toFixed(1)}s`;
    timerFill.style.transform='scaleX(1)'; timeText.textContent='Round time left: —';
    arenaWrap.classList.add('spectate'); showBetBox(); refreshBetHelp();
    localCountdown(LOBBY_TIME, ()=>{});
    clearInterval(tLobbyInt);
    tLobbyInt=setInterval(()=>{
      lobbyLeft=Math.max(0,lobbyLeft-0.1);
      cyclePill.textContent=`Join window: ${lobbyLeft.toFixed(1)}s`;
      timerFill.style.transform=`scaleX(${Math.max(0,lobbyLeft/LOBBY_TIME)})`;
      if(lobbyLeft<=0.01){ clearInterval(tLobbyInt); startMatch(); }
    },100);
  }

  function startMatch(){
    inLobby=false; updateWallet();
    ensureAudio(); if(!primed){ primed=true; startMusic(); } if(!muted) startMusic();

    if(queuedNext>0){ current=queuedNext; queuedNext=0; joinedCurrent=true; arenaWrap.classList.remove('spectate'); showCashBox(); }
    else { current=0; joinedCurrent=false; arenaWrap.classList.add('spectate'); showBetBox(); }

    canCashOut=false; refreshCashBtn(); nextRound();
  }

  function nextRound(){
    round++; if(round>TOTAL_ROUNDS){ startLobby(); return; }
    const beginRound=()=>{
      canPick=joinedCurrent; canCashOut=false; refreshCashBtn();
      board=makeBoard(round); resetCards(round===BONUS_ROUND);
      roundPill.textContent=`Round ${round} / ${TOTAL_ROUNDS}`;
      clearRoundTimers();

      // choose window
      tLock=setTimeout(()=>{ canPick=false; cards.forEach(c=>c.style.pointerEvents='none'); },PICK_WINDOW*1000);
      // reveal timing
      tReveal=setTimeout(()=>{ if(picked) revealChosen(); else revealBoth(); },REVEAL_AT*1000);
      // end of round
      tEnd=setTimeout(()=>{
        if(joinedCurrent && !picked){ // auto cash out with whatever value (unchanged rule)
          wallet+=current; current=0; updateWallet(); joinedCurrent=false; arenaWrap.classList.add('spectate'); showBetBox();
        }
        nextRound();
      },ROUND_TIME*1000);

      const t0=performance.now(); clearInterval(tRound);
      tRound=setInterval(()=>{ const left=Math.max(0,ROUND_TIME-(performance.now()-t0)/1000); timerFill.style.transform=`scaleX(${Math.max(0,left/ROUND_TIME)})`; timeText.textContent=`Round time left: ${left.toFixed(1)}s`; if(left<=0.01) clearInterval(tRound); },100);
    };
    if(round===BONUS_ROUND) bonusSplash(beginRound); else beginRound();
  }
  function clearRoundTimers(){ [tRound,tReveal,tLock,tEnd].forEach(t=>t&&clearInterval(t)); [tReveal,tLock,tEnd].forEach(t=>t&&clearTimeout(t)); tRound=tReveal=tLock=tEnd=null; }

  // ===== CASH OUT (single) =====
  fullCashBtn.onclick=()=>{ if(!joinedCurrent||!canCashOut||current<=0) return; sfx('coin'); wallet+=current; current=0; updateWallet(); joinedCurrent=false; canCashOut=false; arenaWrap.classList.add('spectate'); showBetBox(); refreshBetHelp(); refreshCashBtn(); };

  // ===== BETTING =====
  const queueBet = ()=>{
    if(wallet<prebet) { betNote.textContent='Not enough funds.'; return; }
    wallet-=prebet; queuedNext=prebet; updateWallet();
    // instant UI feedback + show Cancel
    refreshBetHelp();
    betNote.textContent=`Queued ${prebet.toFixed(2)} GEL for the next match.`;
  };
  const cancelQueued = ()=>{
    if(queuedNext>0){ wallet+=queuedNext; queuedNext=0; updateWallet(); }
    refreshBetHelp();
    betNote.textContent='Queued bet cancelled and refunded.';
  };

  minusBtn.onclick=()=> setBet(prebet-1);
  plusBtn.onclick =()=> setBet(prebet+1);
  amountInput.addEventListener('input',()=> setBet(amountInput.value));
  betBtn.onclick=()=>{
    ensureAudio(); if(!primed){ primed=true; startMusic(); }
    if(inLobby){
      queueBet();
    }else{
      if(joinedCurrent) return;           // can't change stake mid-match if you are in
      if(queuedNext>0) queueBet();        // tapping "Queued" again will enqueue another? keep as is
      else queueBet();
    }
  };
  cancelQueueBtn.onclick=cancelQueued;

  // ===== MUSIC TOGGLE =====
  musicBtn.onclick=()=>{ ensureAudio(); if(!primed){ primed=true; } muted=!muted; musicBtn.classList.toggle('muted',muted); if(muted) stopMusic(); else startMusic(); };

  // ===== BOOT =====
  function init(){
    wallet = BASE_WALLET;
    updateWallet();
    setBet(prebet);
    showOnly(lobbyPanel);
  }
  enterBtn.onclick=()=>{ showOnly(arenaPanel); updateWallet(); startLobby(); };
  init();
})();
</script>
</body>
</html>
